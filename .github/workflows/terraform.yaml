name: Terraform checks and deployment

on:
    pull_request:
      branches:
        - master
    push:
      branches:
        - master

jobs:
    terraform-check:
        name: Terraform format check
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Set up Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                terraform_version: 1.9.6

            - name: Terraform format check
              run: terraform fmt -check -list=false
    
    terraform-plan:
        name: Terraform plan
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Set up Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: 1.9.6

            - name: Terraform init
              run: terraform init
            
            - name: Terraform plan
              run: terraform plan
    
    terraform-apply:
        name: Terraform apply
        runs-on: ubuntu-latest
        needs: terraform-plan
        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Set up Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: 1.9.6

            - name: Terraform init
              run: terraform init
            
            - name: Terraform apply
              run: terraform apply -auto-approve
              env:
                AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}